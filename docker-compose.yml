services:
  db:
    image: postgres:12
    environment:
      POSTGRES_DB: ${DB_NAME:-songtexte}
      POSTGRES_USER: ${DB_USER:-songtexts_app}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me_db}
    volumes:
      - songtexts_db:/var/lib/postgresql/data
    networks: [songtexts_net]
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file: .env
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/${DB_NAME:-songtexte}
      SPRING_DATASOURCE_USERNAME: ${DB_USER:-songtexts_app}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-change_me_db}
      SECURITY_JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      APP_ADMIN_PASSWORD: ${APP_ADMIN_PASSWORD}
    depends_on: [db]
    networks: [songtexts_net]
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    networks: [songtexts_net]
    restart: unless-stopped

  proxy:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - letsencrypt:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    depends_on: [ frontend, backend ]
    networks: [ songtexts_net ]
    restart: unless-stopped

  certbot:
    image: certbot/certbot
    volumes:
      - letsencrypt:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    depends_on: [ proxy ]

  certbot-renew:
    image: certbot/certbot
    volumes:
      - letsencrypt:/etc/letsencrypt
      - certbot-www:/var/www/certbot
      - /var/run/docker.sock:/var/run/docker.sock
      - ./:/work
    working_dir: /work
    entrypoint: /bin/sh
    command: >
      -lc '
      set -e;
      echo "[certbot-renew] started";
      while :; do
        echo "[certbot-renew] renewing...";
        certbot renew --webroot -w /var/www/certbot --quiet;
        echo "[certbot-renew] reloading nginx...";
        docker compose exec -T proxy nginx -s reload || docker compose restart proxy;
        echo "[certbot-renew] sleeping 12h...";
        sleep 12h;
      done'
    depends_on: [ proxy ]
    networks: [ songtexts_net ]
    restart: unless-stopped

networks:
  songtexts_net:

volumes:
  songtexts_db:
  letsencrypt:
  certbot-www:
